name: GlobalStockNow AI Pipeline

on:
  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼
  schedule:
    - cron: '0 */4 * * *' # ë§¤ 4ì‹œê°„ë§ˆë‹¤ ìë™ ì‹¤í–‰ (UTC ê¸°ì¤€)

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. íŒŒì´ì¬ í™˜ê²½ ì„¤ì •
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜ (requirements.txt í™œìš©)
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # 4. ë‰´ìŠ¤ ìˆ˜ì§‘ (Gemini ê²€ìƒ‰)
      - name: 1ë‹¨ê³„ - ì†ë³´ ìˆ˜ì§‘ (Collector)
        env:
          # ì†ŒìŠ¤ì½”ë“œì— í‚¤ê°€ ìˆì§€ë§Œ, í˜¹ì‹œ ëª¨ë¥¼ í™˜ê²½ë³€ìˆ˜ ì°¸ì¡°ë¥¼ ìœ„í•´ ë‚¨ê²¨ë‘  (ì„ íƒì‚¬í•­)
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }} 
        run: |
          python collector.py

      # 5. ìˆ˜ì§‘ ê²°ê³¼ ë°±ì—… (ì„ íƒì‚¬í•­)
      - name: ìˆ˜ì§‘ ë°ì´í„° ì €ì¥ (Artifact)
        uses: actions/upload-artifact@v4
        with:
          name: raw-news-data-${{ github.run_number }}
          path: breaking_news.json
          retention-days: 3

      # 6. AI ë¶„ì„ (Gemini 1.5 Pro)
      - name: 2ë‹¨ê³„ - ì‹¬ì¸µ ë¶„ì„ (Analyzer)
        run: |
          python analyzer.py

      # 7. ë¶„ì„ ê²°ê³¼ ë°±ì—…
      - name: ë¶„ì„ ë¦¬í¬íŠ¸ ì €ì¥ (Artifact)
        uses: actions/upload-artifact@v4
        with:
          name: ai-analysis-report-${{ github.run_number }}
          path: analyzed_news.json
          retention-days: 3

      # 8. í…”ë ˆê·¸ë¨ ì•Œë¦¼ ë°œì†¡
      - name: 3ë‹¨ê³„ - í…”ë ˆê·¸ë¨ ë¸Œë¦¬í•‘
        if: always() # ì• ë‹¨ê³„ê°€ ì‹¤íŒ¨í•´ë„ ì•Œë¦¼ ì‹œë„
        run: |
          # analyzed_news.jsonì—ì„œ í•„ìš”í•œ ì •ë³´ë§Œ ë½‘ì•„ì„œ ë©”ì‹œì§€ ë§Œë“¤ê¸°
          # jqë¥¼ ì‚¬ìš©í•˜ì—¬ JSON íŒŒì‹± (ìƒˆë¡œìš´ í¬ë§·ì¸ .reports[] êµ¬ì¡° ëŒ€ì‘)
          
          REPORT_CONTENT=$(jq -r '.reports[] | "ğŸš¨ <b>\(.title)</b>%0A(Impact: \(.impact_score)/10)%0AğŸ“Š ê´€ë ¨ì¢…ëª©: \(.related_stocks | join(", "))%0AğŸ’¡ ë¶„ì„: \(.analysis)%0A%0A"' analyzed_news.json 2>/dev/null)
          
          if [ -z "$REPORT_CONTENT" ]; then
            REPORT_CONTENT="âœ… í˜„ì¬ ì˜í–¥ë„ 7.0 ì´ìƒì˜ íŠ¹ì´ì‚¬í•­ ë‰´ìŠ¤ ì—†ìŒ."
          fi

          # í…”ë ˆê·¸ë¨ API ì „ì†¡
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d parse_mode=HTML \
            -d text="<b>ğŸŒ GlobalStockNow AI ë¸Œë¦¬í•‘</b>%0A%0A$REPORT_CONTENT"
